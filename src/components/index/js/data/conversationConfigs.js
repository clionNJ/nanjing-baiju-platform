const conversationConfigs = {
    'zh-CN': {
        title: '互动问答',
        userLabel: '访客',
        assistantLabel: '传承人',
        inputPlaceholder: '请输入您的问题或向我点唱...',
        sendButton: '发送',
        voiceButtonIdle: '语音提问',
        voiceButtonListening: '停止录音',
        autoDetectLabel: '自动识别语言',
        ttsLabel: '语音播报',
        detectedLanguageLabel: '识别语言：',
        noDetection: '待识别',
        welcome: '您好，我是白局数字传承人，很高兴与您交流。可以问我白局相关问题，或让我演唱经典唱段。',
        listening: '正在聆听，请开口说话……',
        recognitionUnsupported: '当前浏览器暂不支持语音识别，请使用最新版的 Chrome 或 Edge 浏览器。',
        thinking: '让我想一想……',
        ttsPlaying: '语音播报中…',
        ttsStopped: '语音播报已结束。',
        error: '抱歉，我暂时无法处理，请稍后再试。',
        noSpeech: '未检测到语音，请重试。',
        audioCapture: '无法访问麦克风，请检查权限设置。',
        networkError: '网络错误，请检查网络连接。',
        permissionDenied: '麦克风权限被拒绝，请在浏览器设置中允许访问麦克风。',
        serviceNotAllowed: '语音识别服务不可用，请稍后再试。',
        httpsRequired: '语音识别需要HTTPS连接，请使用安全连接访问。',
        languageNames: {
            'zh-CN': '中文',
            'en': '英语',
            'es': '西班牙语',
            'fr': '法语',
            'ja': '日语',
            'ar': '阿拉伯语'
        },
        responses: {
            greeting: '您好！欢迎来到南京白局数字平台。',
            intro: '白局是南京地区的传统曲艺，起源于明代，因演唱时穿着白色长衫而得名，唱词通俗、旋律清亮，是国家级非物质文化遗产。',
            history: '白局由明清时期的说唱形式发展而来，融合了民间说唱、琴曲等元素，清末民初进入茶馆戏台，代表人物有朱自清、吴树德等传承人。',
            instrument: '白局常用乐器有扬琴、琵琶、三弦、笛子等，演唱者还会以手拍节，形成“口唱手打”的特色表现。',
            costume: '传统白局演员多穿白色长衫配腰带，女性还会搭配绣花披肩和头饰，以突出素雅端庄的舞台形象。',
            default: '我可以为您介绍白局的历史、曲目、传承人，也可以为您演唱{song1}、{song2}等唱段，欢迎提问！',
            singGeneric: '好的，我这就为您献上{song}，请您欣赏。',
            singSong1: '好的，马上为您演唱{song}，再现秦淮灯火的风情。',
            singSong2: '收到，让我们一起感受{song}中南京四季的光景。',
            singSong3: '没问题，{song}将带您品味南京的风味故事。'
        }
    },
    'en': {
        title: 'Interactive Q&A',
        userLabel: 'Visitor',
        assistantLabel: 'Inheritor',
        inputPlaceholder: 'Ask a question or request a song...',
        sendButton: 'Send',
        voiceButtonIdle: 'Voice Question',
        voiceButtonListening: 'Stop Recording',
        autoDetectLabel: 'Auto language detection',
        ttsLabel: 'Voice reply',
        detectedLanguageLabel: 'Detected language:',
        noDetection: 'Pending',
        welcome: 'Hello, I am the digital inheritor of Baiju. Feel free to ask about Baiju or request a classic excerpt.',
        listening: 'Listening... please speak clearly.',
        recognitionUnsupported: 'Speech recognition is not supported in this browser. Please try the latest Chrome or Edge.',
        thinking: 'Let me think...',
        ttsPlaying: 'Playing voice reply...',
        ttsStopped: 'Voice reply stopped.',
        error: 'Sorry, I could not process that. Please try again.',
        noSpeech: 'No speech detected. Please try again.',
        audioCapture: 'Cannot access microphone. Please check permissions.',
        networkError: 'Network error. Please check your connection.',
        permissionDenied: 'Microphone permission denied. Please allow microphone access in browser settings.',
        serviceNotAllowed: 'Speech recognition service unavailable. Please try again later.',
        httpsRequired: 'Speech recognition requires HTTPS. Please use a secure connection.',
        languageNames: {
            'zh-CN': 'Chinese',
            'en': 'English',
            'es': 'Spanish',
            'fr': 'French',
            'ja': 'Japanese',
            'ar': 'Arabic'
        },
        responses: {
            greeting: 'Hello! Welcome to the Nanjing Baiju digital platform.',
            intro: 'Baiju is a traditional narrative singing art from Nanjing. It began in the Ming dynasty and was named after the white robes performers wore. The lyrics are vivid, the melodies bright, and it is listed as a National Intangible Cultural Heritage.',
            history: 'Baiju evolved from storytelling arts in the Ming and Qing dynasties, blending folk ballads and instrumental styles. It flourished in teahouses during the late Qing and early Republic eras, with masters such as Zhu Ziqing and Wu Shude carrying it forward.',
            instrument: 'Typical Baiju accompaniment includes yangqin, pipa, sanxian, and dizi. Performers also clap rhythm with their hands, creating the signature “singing with handmade percussion” style.',
            costume: 'Traditional performers wear long white gowns with sashes, while female artists may add embroidered shawls and hair ornaments to highlight an elegant stage presence.',
            default: 'I can introduce Baiju history, repertoire, and inheritors, or sing excerpts such as {song1} and {song2}. Feel free to ask!',
            singGeneric: 'Sure, let me sing {song} for you.',
            singSong1: 'With pleasure. Enjoy {song} and the festive glow of Qinhuai.',
            singSong2: 'Certainly. Let\'s experience the four seasons of Nanjing in {song}.',
            singSong3: 'Of course. {song} shares the flavorful stories of Nanjing.'
        }
    },
    'es': {
        title: 'Preguntas interactivas',
        userLabel: 'Visitante',
        assistantLabel: 'Heredero',
        inputPlaceholder: 'Haz una pregunta o pide una canción...',
        sendButton: 'Enviar',
        voiceButtonIdle: 'Pregunta por voz',
        voiceButtonListening: 'Detener grabación',
        autoDetectLabel: 'Detectar idioma automáticamente',
        ttsLabel: 'Respuesta por voz',
        detectedLanguageLabel: 'Idioma detectado:',
        noDetection: 'En espera',
        welcome: 'Hola, soy el heredero digital del Baiju. Puedes preguntarme sobre el Baiju o pedirme un fragmento clásico.',
        listening: 'Escuchando... por favor habla con claridad.',
        recognitionUnsupported: 'El reconocimiento de voz no está disponible en este navegador. Prueba con la última versión de Chrome o Edge.',
        thinking: 'Déjame pensar...',
        ttsPlaying: 'Reproduciendo respuesta de voz...',
        ttsStopped: 'Respuesta de voz detenida.',
        error: 'Lo siento, no pude procesarlo. Inténtalo de nuevo.',
        noSpeech: 'No se detectó voz. Por favor, inténtalo de nuevo.',
        audioCapture: 'No se puede acceder al micrófono. Por favor, verifica los permisos.',
        networkError: 'Error de red. Por favor, verifica tu conexión.',
        permissionDenied: 'Permiso de micrófono denegado. Por favor, permite el acceso al micrófono en la configuración del navegador.',
        serviceNotAllowed: 'El servicio de reconocimiento de voz no está disponible. Por favor, inténtalo más tarde.',
        httpsRequired: 'El reconocimiento de voz requiere HTTPS. Por favor, usa una conexión segura.',
        languageNames: {
            'zh-CN': 'Chino',
            'en': 'Inglés',
            'es': 'Español',
            'fr': 'Francés',
            'ja': 'Japonés',
            'ar': 'Árabe'
        },
        responses: {
            greeting: '¡Hola! Bienvenido a la plataforma digital del Baiju de Nankín.',
            intro: 'El Baiju es un arte tradicional de canto narrativo originario de Nankín. Surgió en la dinastía Ming y se nombra por las túnicas blancas que usaban los intérpretes. Las letras son populares, las melodías brillantes y está reconocido como Patrimonio Cultural Inmaterial nacional.',
            history: 'El Baiju evolucionó a partir de formas narrativas de las épocas Ming y Qing, combinando baladas populares y estilos instrumentales. A finales de la dinastía Qing y comienzos de la República floreció en los salones de té, con maestros como Zhu Ziqing y Wu Shude como referentes.',
            instrument: 'Los instrumentos habituales incluyen yangqin, pipa, sanxian y dizi. Los intérpretes también marcan el ritmo con las palmas, creando el estilo característico de “cantar y percutir con las manos”.',
            costume: 'Los artistas tradicionales visten largas túnicas blancas con cinturón; las intérpretes suelen añadir chales bordados y adornos en el cabello para resaltar una presencia escénica elegante.',
            default: 'Puedo contarte sobre la historia, el repertorio y los herederos del Baiju, o cantar fragmentos como {song1} y {song2}. ¡Pregúntame lo que quieras!',
            singGeneric: 'Claro, cantaré {song} para ti.',
            singSong1: 'Con gusto, disfruta {song} y el ambiente festivo del Qinhuai.',
            singSong2: 'Perfecto, vivamos las cuatro estaciones de Nankín en {song}.',
            singSong3: 'Por supuesto, {song} te llevará a saborear las historias gastronómicas de Nankín.'
        }
    },
    'fr': {
        title: 'Questions interactives',
        userLabel: 'Visiteur',
        assistantLabel: 'Héritier',
        inputPlaceholder: 'Posez une question ou demandez un air...',
        sendButton: 'Envoyer',
        voiceButtonIdle: 'Question vocale',
        voiceButtonListening: 'Arrêter l\'enregistrement',
        autoDetectLabel: 'Détection automatique de la langue',
        ttsLabel: 'Réponse vocale',
        detectedLanguageLabel: 'Langue détectée :',
        noDetection: 'En attente',
        welcome: 'Bonjour, je suis l\'héritier numérique du Baiju. N\'hésitez pas à me poser vos questions ou à me demander un extrait.',
        listening: 'À l\'écoute... veuillez parler clairement.',
        recognitionUnsupported: 'La reconnaissance vocale n\'est pas disponible sur ce navigateur. Essayez la dernière version de Chrome ou Edge.',
        thinking: 'Laissez-moi réfléchir...',
        ttsPlaying: 'Lecture de la réponse vocale...',
        ttsStopped: 'Réponse vocale terminée.',
        error: 'Désolé, je ne peux pas traiter votre demande pour le moment.',
        noSpeech: 'Aucune voix détectée. Veuillez réessayer.',
        audioCapture: 'Impossible d\'accéder au microphone. Veuillez vérifier les permissions.',
        networkError: 'Erreur réseau. Veuillez vérifier votre connexion.',
        permissionDenied: 'Permission du microphone refusée. Veuillez autoriser l\'accès au microphone dans les paramètres du navigateur.',
        serviceNotAllowed: 'Le service de reconnaissance vocale n\'est pas disponible. Veuillez réessayer plus tard.',
        httpsRequired: 'La reconnaissance vocale nécessite HTTPS. Veuillez utiliser une connexion sécurisée.',
        languageNames: {
            'zh-CN': 'Chinois',
            'en': 'Anglais',
            'es': 'Espagnol',
            'fr': 'Français',
            'ja': 'Japonais',
            'ar': 'Arabe'
        },
        responses: {
            greeting: 'Bonjour ! Bienvenue sur la plateforme numérique du Baiju de Nankin.',
            intro: 'Le Baiju est un art vocal narratif traditionnel de Nankin. Apparu sous la dynastie Ming, il doit son nom aux longues robes blanches des interprètes. Les paroles sont populaires, la mélodie claire, et il est inscrit au patrimoine culturel immatériel national.',
            history: 'Le Baiju s\'est développé à partir des arts de récit des époques Ming-Qing, mêlant ballades populaires et accompagnements instrumentaux. À la fin des Qing et au début de la République, il prospère dans les maisons de thé, porté par des maîtres tels que Zhu Ziqing et Wu Shude.',
            instrument: 'L\'accompagnement comprend souvent le yangqin, le pipa, le sanxian et la flûte dizi. Les chanteurs marquent aussi le rythme avec les mains, créant le style typique « chanter et frapper ».',
            costume: 'Traditionnellement, les artistes portent une longue robe blanche ceinturée ; les interprètes féminines ajoutent un châle brodé et des ornements de coiffure pour souligner l\'élégance scénique.',
            default: 'Je peux vous présenter l\'histoire, le répertoire et les héritiers du Baiju, ou chanter des airs comme {song1} et {song2}. Posez-moi vos questions !',
            singGeneric: 'Très bien, je vous interprète {song}.',
            singSong1: 'Avec plaisir. Profitons ensemble de l\'ambiance festive de {song}.',
            singSong2: 'Bien entendu. Découvrons les quatre saisons de Nankin dans {song}.',
            singSong3: 'Bien sûr. {song} vous fera goûter aux saveurs de Nankin.'
        }
    },
    'ja': {
        title: 'インタラクティブQ&A',
        userLabel: '来訪者',
        assistantLabel: '伝承者',
        inputPlaceholder: '質問やリクエストを入力してください...',
        sendButton: '送信',
        voiceButtonIdle: '音声で質問',
        voiceButtonListening: '録音を停止',
        autoDetectLabel: '言語を自動認識',
        ttsLabel: '音声で回答',
        detectedLanguageLabel: '認識言語：',
        noDetection: '待機中',
        welcome: 'こんにちは、私は白局のデジタル伝承者です。白局についての質問や演唱のリクエストをどうぞ。',
        listening: '傾聴中です。はっきりとお話しください。',
        recognitionUnsupported: 'このブラウザでは音声認識が利用できません。最新版のChromeまたはEdgeをお試しください。',
        thinking: '少々お待ちください…',
        ttsPlaying: '音声回答を再生しています...',
        ttsStopped: '音声再生を終了しました。',
        error: '申し訳ありません。うまく処理できませんでした。もう一度お試しください。',
        noSpeech: '音声が検出されませんでした。もう一度お試しください。',
        audioCapture: 'マイクにアクセスできません。権限設定を確認してください。',
        networkError: 'ネットワークエラー。接続を確認してください。',
        permissionDenied: 'マイクの権限が拒否されました。ブラウザの設定でマイクへのアクセスを許可してください。',
        serviceNotAllowed: '音声認識サービスが利用できません。後でもう一度お試しください。',
        httpsRequired: '音声認識にはHTTPS接続が必要です。安全な接続を使用してください。',
        languageNames: {
            'zh-CN': '中国語',
            'en': '英語',
            'es': 'スペイン語',
            'fr': 'フランス語',
            'ja': '日本語',
            'ar': 'アラビア語'
        },
        responses: {
            greeting: 'こんにちは！南京白局デジタルプラットフォームへようこそ。',
            intro: '白局は南京で生まれた伝統的な語り物の歌芸です。明代に起源をもち、白い長衣を着て演じたことからこの名がつきました。詞は親しみやすく旋律は澄んでおり、国家級非物質文化遺産に指定されています。',
            history: '白局は明清期の語り芸から発展し、民間の歌や器楽の要素を取り入れました。清末から民国期には茶館の舞台で盛んになり、朱自清や呉樹徳などの伝承者が活躍しました。',
            instrument: '伴奏には揚琴・琵琶・三弦・笛子などが用いられ、演者は手拍子でリズムを取り、独特の「歌って手で打つ」スタイルを生み出します。',
            costume: '伝統的な出演者は白い長衣に帯を締め、女性は刺繍のショールや髪飾りを合わせ、清雅な舞台姿を表現します。',
            default: '白局の歴史や曲目、伝承者についてご紹介したり、{song1}や{song2}などを演唱することもできます。どうぞお気軽にお尋ねください。',
            singGeneric: '承知しました。{song}をお聴きください。',
            singSong1: '喜んで。秦淮灯会の華やかさを描く{song}をお届けします。',
            singSong2: 'かしこまりました。南京の四季を描く{song}を一緒に味わいましょう。',
            singSong3: 'もちろんです。{song}で南京の味わいをご堪能ください。'
        }
    },
    'ar': {
        title: 'أسئلة تفاعلية',
        userLabel: 'الزائر',
        assistantLabel: 'الوارث',
        inputPlaceholder: 'اكتب سؤالك أو اطلب مقطعاً غنائياً...',
        sendButton: 'إرسال',
        voiceButtonIdle: 'سؤال صوتي',
        voiceButtonListening: 'إيقاف التسجيل',
        autoDetectLabel: 'التعرّف التلقائي على اللغة',
        ttsLabel: 'إجابة صوتية',
        detectedLanguageLabel: 'اللغة المكتشفة:',
        noDetection: 'بانتظار',
        welcome: 'مرحباً، أنا الوريث الرقمي لفن البايجو. يمكنك سؤالي عن البايجو أو طلب مقطع غنائي كلاسيكي.',
        listening: 'أستمع إليك... الرجاء التحدث بوضوح.',
        recognitionUnsupported: 'التعرّف على الصوت غير متاح في هذا المتصفح. يرجى تجربة أحدث نسخة من Chrome أو Edge.',
        thinking: 'دعني أفكر...',
        ttsPlaying: 'جاري تشغيل الإجابة الصوتية...',
        ttsStopped: 'توقفت الإجابة الصوتية.',
        error: 'عذراً، تعذّر المعالجة. حاول مرة أخرى.',
        noSpeech: 'لم يتم اكتشاف صوت. يرجى المحاولة مرة أخرى.',
        audioCapture: 'لا يمكن الوصول إلى الميكروفون. يرجى التحقق من الصلاحيات.',
        networkError: 'خطأ في الشبكة. يرجى التحقق من الاتصال.',
        permissionDenied: 'تم رفض إذن الميكروفون. يرجى السماح بالوصول إلى الميكروفون في إعدادات المتصفح.',
        serviceNotAllowed: 'خدمة التعرف على الصوت غير متاحة. يرجى المحاولة لاحقاً.',
        httpsRequired: 'التعرف على الصوت يتطلب HTTPS. يرجى استخدام اتصال آمن.',
        languageNames: {
            'zh-CN': 'الصينية',
            'en': 'الإنجليزية',
            'es': 'الإسبانية',
            'fr': 'الفرنسية',
            'ja': 'اليابانية',
            'ar': 'العربية'
        },
        responses: {
            greeting: 'مرحباً! أهلاً بك في المنصة الرقمية لفن البايجو في نانجينغ.',
            intro: 'البايجو فن غنائي قصصي تقليدي من نانجينغ، ظهر في عهد أسرة مينغ وسُمّي نسبة إلى الثياب البيضاء التي يرتديها المؤدون. كلماته قريبة من الجمهور وألحانه رقيقة، وقد أُدرج ضمن قائمة التراث الثقافي غير المادي الوطني.',
            history: 'تطور البايجو من فنون السرد في عهدي مينغ وتشينغ، ودمج عناصر من الأغاني الشعبية والآلات الموسيقية. ازدهر في مقاهي الشاي أواخر أسرة تشينغ وبداية الجمهورية، ومن رواده البارزين الأساتذة تشو تسي تشينغ ووو شو ده.',
            instrument: 'تشمل الآلات المصاحبة عادةً اليانغتشين والبيبا والسانشيان والناي الصيني (دزي). كما يضرب المؤدي الإيقاع بكفيه، فيبرز أسلوب «الغناء مع الإيقاع اليدوي» المميز.',
            costume: 'يرتدي الفنانون التقليديون أردية بيضاء طويلة مع حزام، وتضيف المؤديات شالات مطرزة وزينة للشعر لإبراز هيئة مسرحية أنيقة.',
            default: 'يمكنني إطلاعك على تاريخ البايجو ومقاطعه وورّاثه، أو أن أؤدي مقاطع مثل {song1} و{song2}. لا تتردد في طرح سؤالك!',
            singGeneric: 'بكل سرور، سأؤدي {song} من أجلك.',
            singSong1: 'حاضر، استمتع بأجواء مهرجان أضواء تشينهواي مع {song}.',
            singSong2: 'بكل تأكيد، فلنعيش معاً فصول نانجينغ الأربعة في {song}.',
            singSong3: 'أكيد، {song} سيأخذك في رحلة بين نكهات نانجينغ.'
        }
    }
};

const recognitionLangMap = {
    'zh-CN': 'zh-CN',
    'en': 'en-US',
    'es': 'es-ES',
    'fr': 'fr-FR',
    'ja': 'ja-JP',
    'ar': 'ar-SA'
};

const ttsLangMap = {
    'zh-CN': 'zh-CN',
    'en': 'en-US',
    'es': 'es-ES',
    'fr': 'fr-FR',
    'ja': 'ja-JP',
    'ar': 'ar-SA'
};

const conversationState = {
    autoDetect: true,
    ttsEnabled: true,
    recognitionSupported: 'SpeechRecognition' in window || 'webkitSpeechRecognition' in window,
    speechSupported: 'speechSynthesis' in window,
    recognition: null,
    isListening: false,
    labels: null,
    elements: {},
    currentStatusType: 'idle',
    lastDetectedLang: 'zh-CN',
    initialized: false
};

